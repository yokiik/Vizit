# Заметки о миграции на FastAPI

## Выполненные изменения

### 1. FastAPI миграция
- ✅ `web/server.py` переписан на FastAPI
- ✅ Созданы Pydantic модели в `web/schemas.py` для всех API эндпоинтов
- ✅ Добавлена автоматическая Swagger документация по адресу `/docs` и `/redoc`
- ✅ Все существующие эндпоинты сохранены и работают

### 2. Обновлены зависимости
- ✅ `requirements.txt`: удален Flask, добавлены FastAPI, Uvicorn, Pydantic
- ✅ Сохранены все остальные зависимости (Selenium, BeautifulSoup4 и т.д.)

### 3. Обновлены точки входа
- ✅ `wsgi.py` - переписан для работы с Uvicorn (ASGI вместо WSGI)
- ✅ `main.py` - обновлен для запуска через Uvicorn

### 4. Обновление скрипта деплоя
- ✅ Обновлен `deploy.sh` для работы с Uvicorn вместо Gunicorn
- ✅ Скрипт можно запускать вручную или настроить в cron для периодической проверки обновлений

### 5. Обновлены конфигурации
- ✅ `systemd/rli-systems.service` - обновлен для работы с Uvicorn
- ✅ `nginx/rli-systems.conf` - обновлен для работы с FastAPI

## Новые возможности

### Swagger документация
После запуска приложения доступна автоматическая документация API:
- Swagger UI: http://localhost:8088/docs
- ReDoc: http://localhost:8088/redoc

### Автоматический деплой
При push в ветку `main` или `master` автоматически:
1. Обновляется код через `git pull`
2. Обновляются зависимости
3. Перезапускается systemd сервис

## Обратная совместимость

Все API эндпоинты остались без изменений:
- Пути остались теми же (`/api/tasks`, `/api/settings` и т.д.)
- Формат запросов и ответов не изменился
- Фронтенд не требует изменений

## Запуск

### Локальная разработка
```bash
python main.py
```

### Production через systemd
```bash
sudo systemctl start rli-systems.service
```

### Production через Uvicorn напрямую
```bash
uvicorn wsgi:application --host 0.0.0.0 --port 8088 --workers 4
```

## Важные заметки

1. **Статические файлы**: монтируются автоматически из `web/static/`
2. **Шаблоны**: использует Jinja2 напрямую (не через fastapi.templating)
3. **CORS**: настроен для разрешения всех источников (для разработки)
4. **Валидация**: все запросы автоматически валидируются через Pydantic

## Отличия от Flask

1. **Асинхронные функции**: все эндпоинты теперь `async`
2. **Валидация**: автоматическая через Pydantic модели
3. **Ошибки**: используются HTTPException вместо tuple (code, body)
4. **Ответы**: используется response_model вместо jsonify
5. **Запросы**: Body автоматически парсится в Pydantic модели

## Следующие шаги

1. Установить зависимости: `pip install -r requirements.txt`
2. Обновить systemd сервис на сервере
3. Перезапустить приложение: `sudo systemctl restart rli-systems.service`
4. Для автоматических обновлений настроить cron (см. DEPLOYMENT_GUIDE.md)

## Обновление кода

Используйте скрипт `deploy.sh` для автоматического обновления:
```bash
./deploy.sh
```

Или настройте cron для периодической проверки обновлений (см. `DEPLOYMENT_GUIDE.md`)

